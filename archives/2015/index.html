<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Archives: 2015 | CP WRITINGS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="CP WRITINGS">
<meta property="og:url" content="http://yoursite.com/archives/2015/">
<meta property="og:site_name" content="CP WRITINGS">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CP WRITINGS">
<meta name="twitter:description">

  
    <link rel="alternative" href="/atom.xml" title="CP WRITINGS" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  
</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">CP WRITINGS</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        
          <a id="nav-home-icon" class="nav-icon" href="/"></a>
        
          <a id="nav-archives-icon" class="nav-icon" href="/archives"></a>
        
          <a id="nav-about-icon" class="nav-icon" href="/about/index.html"></a>
        
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
      </nav>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-2015-summary" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2015/12/31/2015-summary/">2015 年终总结</a>
  

      </header>
    
    <time class="article-date" datetime="2015-12-31T03:10:31.000Z" itemprop="datePublished">12-31-2015</time>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Life/">Life</a>
  </div>

  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p>上海的冬天不是很好过，屋里屋外都很冷。忙碌中，不觉间，这一年已经来到了12月31号，15年就快要结束了。这两年自己也算养成了在一年结束的时候写一篇年終总结的习惯，好让自己来和这一年说再见。</p>
<p>15年对自己影响最大的事情是奶奶的过世。奶奶的逝去的那一阵子，让我恍惚间有了一种了无牵挂的感觉。那段时间，我觉得自己从此无依无靠；没有了任何牵挂，也无了任何寄托。自己可以随风漂泊去任何地方了。</p>
<p>每当我遇到自己恐惧的事情，会想到奶奶；想到奶奶临终前独自面对死亡，我自己头上的这点小事，真的不算个事。从我能记事开始，和奶奶生活的这二十多年，感觉时间很平静的就流逝了，我对奶奶也没有特别的故事可以回忆。只是有时候走在路上，躺在床上，会突然很想念她老人家。</p>
<p>其他的事情需要记录的并不多；15年我常去健身房，由于我从小有点驼背，加上工作性质，长期呆在电脑前，导致现在颈背状况很差，有时候会感觉特别痛。本来希望能通过健身矫正把这个毛病改掉，然而15年收效微微，但16年还是要坚持，相信正确的方法可以帮助自己克服掉这个长期以来的毛病。</p>
<p>另外就是今年终于把自己的博客写起来了，博客这个事情，自己老早就开通了，但能保持一个月至少两篇算是15年坚持下来的习惯；博文质量还有待提高，16年自己会坚持写作的。可以说坚持写作给予我的反馈是很棒的，会有一种特别的满足感。看着自己的文字，我能确切的知道，自己不是在混日子，自己平日里是有在思考的，自己是可以用文字把自己的想法，技巧，知识记录下来的，这一点让我感到安心。</p>
<p>整理这篇总结的时候，已经是2016年了，2016年希望自己能过的更随性，更自由一些。</p>
<p>2015年过去了，我很怀念它。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/12/31/2015-summary/" data-id="1j77be4r1c7iqvsh" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-2015-2nd-movie-list" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2015/12/27/2015-2nd-movie-list/">2015下半年电影清单</a>
  

      </header>
    
    <time class="article-date" datetime="2015-12-27T14:16:11.000Z" itemprop="datePublished">12-27-2015</time>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Movie/">Movie</a>
  </div>

  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>中国大陆</strong></p>
<ul>
<li><a href="http://movie.douban.com/subject/25710912/" target="_blank" rel="external">港囧 (2015)</a></li>
<li><a href="http://movie.douban.com/subject/26277313/" target="_blank" rel="external">西游记之大圣归来 (2015)</a> ✔</li>
<li><a href="http://movie.douban.com/subject/3077412/" target="_blank" rel="external">寻龙诀 (2015)</a> ✔</li>
</ul>
<p><strong>中国香港</strong></p>
<ul>
<li><a href="http://movie.douban.com/subject/1298898/" target="_blank" rel="external">暗战 暗戰 (1999)</a> ✔</li>
</ul>
<p><strong>中国台湾</strong></p>
<ul>
<li><a href="http://movie.douban.com/subject/26366465/" target="_blank" rel="external">我的少女时代 我的少女時代 (2015)</a>✔</li>
</ul>
<p><strong>欧美</strong></p>
<ul>
<li><a href="http://movie.douban.com/subject/1866473/" target="_blank" rel="external">蚁人 Ant-Man (2015)</a> ✔</li>
<li><a href="http://movie.douban.com/subject/11624706/" target="_blank" rel="external">小黄人大眼萌 Minions (2015)</a></li>
<li><a href="http://movie.douban.com/subject/10727641/" target="_blank" rel="external">碟中谍5：神秘国度 Mission: Impossible - Rogue Nation (2015)</a> ✔</li>
<li><a href="http://movie.douban.com/subject/10463953/" target="_blank" rel="external">模仿游戏 The Imitation Game (2014)</a> ✔</li>
<li><a href="http://movie.douban.com/subject/10440138/" target="_blank" rel="external">侏罗纪世界 Jurassic World (2015)</a> ✔</li>
<li><a href="http://movie.douban.com/subject/1293530/" target="_blank" rel="external">角斗士 Gladiator (2000)</a>✔</li>
<li><a href="http://movie.douban.com/subject/1945780/" target="_blank" rel="external">血色将至 There Will Be Blood (2007)</a>✔✔✔</li>
<li><a href="http://movie.douban.com/subject/3008247/" target="_blank" rel="external">穿条纹睡衣的男孩 The Boy in the Striped Pajamas (2008)</a></li>
<li><a href="http://movie.douban.com/subject/25773932/" target="_blank" rel="external">爆裂鼓手 Whiplash (2014)</a> ✔✔</li>
<li><a href="http://movie.douban.com/subject/2044089/" target="_blank" rel="external">杀手没有假期 In Bruges (2008)</a></li>
<li><a href="http://movie.douban.com/subject/3592854/" target="_blank" rel="external">疯狂的麦克斯4：狂暴之路 （Mad Max: Fury Road）</a>✔</li>
<li><a href="http://movie.douban.com/subject/24815950/" target="_blank" rel="external">万物理论 The Theory of Everything (2014)</a> ✔</li>
<li><a href="http://movie.douban.com/subject/25766754/" target="_blank" rel="external">年轻气盛 Youth (2015)</a> ✔</li>
<li><a href="http://movie.douban.com/subject/10533913/" target="_blank" rel="external">头脑特工队 Inside Out (2015)</a></li>
<li><a href="http://movie.douban.com/subject/11620560/" target="_blank" rel="external">007：幽灵党 Spectre (2015)</a> ✔</li>
<li><a href="http://movie.douban.com/subject/6873042/" target="_blank" rel="external">明日世界 Tomorrowland (2015)</a></li>
<li><a href="http://movie.douban.com/subject/6846893/" target="_blank" rel="external">超能查派 Chappie (2015)</a></li>
</ul>
<p><strong>日本</strong></p>
<ul>
<li><a href="http://movie.douban.com/subject/25814707/" target="_blank" rel="external">小森林 冬春篇 リトル・フォレスト 冬・春 (2015)</a> ✔✔✔✔</li>
<li><a href="http://movie.douban.com/subject/2000741/" target="_blank" rel="external">母亲 母べえ (2008)</a> ✔✔✔✔</li>
<li><a href="http://movie.douban.com/subject/26147706/" target="_blank" rel="external">花与爱丽丝杀人事件 花とアリス殺人事件 (2015)</a> ✔✔✔</li>
</ul>
<p><strong>美剧</strong></p>
<ul>
<li><a href="http://movie.douban.com/subject/26290409/" target="_blank" rel="external">黑客军团 第一季 Mr. Robot Season 1 (2015)</a> ✔</li>
<li><a href="http://movie.douban.com/subject/10748120/" target="_blank" rel="external">真探 第一季 True Detective Season 1 (2014)</a> ✔✔✔</li>
<li><a href="http://movie.douban.com/subject/25837700/" target="_blank" rel="external">真探 第二季 True Detective Season 2 (2015)</a></li>
<li><a href="http://movie.douban.com/subject/25850640/" target="_blank" rel="external">毒枭 第一季 Narcos Season 1 (2015)</a> ✔✔</li>
<li><a href="http://movie.douban.com/subject/20644938/" target="_blank" rel="external">硅谷 第一季 Silicon Valley Season 1 (2014)</a>✔</li>
<li><a href="http://movie.douban.com/subject/25871679/" target="_blank" rel="external">硅谷 第二季 Silicon Valley Season 2 (2015)</a>✔</li>
<li><a href="http://movie.douban.com/subject/25770124/" target="_blank" rel="external">政局边缘 The Brink (2015)</a></li>
</ul>
<p><strong>英剧</strong></p>
<ul>
<li><a href="http://movie.douban.com/subject/26170816/" target="_blank" rel="external">真实的人类 第一季 Humans Season 1 (2015)</a>✔</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/12/27/2015-2nd-movie-list/" data-id="cei9vo92t2ewo7xr" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-iOS-reverse-engineering-02" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2015/11/30/iOS-reverse-engineering-02/">iOS逆向工程-0x01－工具篇-Cycript</a>
  

      </header>
    
    <time class="article-date" datetime="2015-11-30T14:00:07.000Z" itemprop="datePublished">11-30-2015</time>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Tech/">Tech</a>
  </div>

  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p>对于初开始学习iOS逆向工程的人来说，实现一个<code>tweak</code>可以算是入门逆向工程了。</p>
<p>当然了，可能你现在还不知道<code>tweak</code>是什么。简单来说，你可以把一个tweak当作某一个app的一个插件（类似于浏览器广告屏蔽插件）。在app运行的时候，tweak会hook住某个函数，然后在hook的函数里面，你可以插入你的代码。</p>
<blockquote>
<p>比如用户在登陆微信账号的时候，tweak可以hook住登录函数，dump出用户的账号密码</p>
</blockquote>
<p>那问题来了，我们要如何知道哪个函数是账号登录函数咧？<strong>这就涉及到我们如何去分析一个iOS app</strong></p>
<h2 id="分析_iOS_app_的两种方法">分析 iOS app 的两种方法</h2>
<ul>
<li><p>运行时分析</p>
<ul>
<li>GDB/LLDB</li>
<li>Cycript</li>
<li>Logify</li>
<li>weak_classdump</li>
<li>InspectiveC</li>
</ul>
</li>
</ul>
<ul>
<li><p>可执行代码分析</p>
<ul>
<li>dumpdecrpted</li>
<li>class_dump,class_dump_z,classdump_dyld</li>
<li>Disassemblers<ul>
<li>IDA</li>
<li>Hopper</li>
<li>otool</li>
</ul>
</li>
<li>strings</li>
<li>nm</li>
</ul>
</li>
</ul>
<p>先不要被这么多的工具多吓到，我们一样一样来。相比对汇编代码的分析，动态分析要简单，容易上手很多，对新手而言，也更加容易获取到乐趣。所以我们先从最好玩的Cycript开始。</p>
<h3 id="Cycript">Cycript</h3>
<p><a href="http://www.cycript.org/" target="_blank" rel="external">Cycript</a>最重要的特性是，它可以hook住 iOS／macosx 上面正在运行的进程，并通过终端使用objective_c或javascript语法去打印和修改该应用的运行时信息。我们可以把它当作一个可以debug没有源代码程序的工具。</p>
<p>以下是 Cycript 的用途：</p>
<ul>
<li>能够hook正在运行的进程，并打印相关信息，如 appdelegate,rootViewController</li>
<li>对程序中的类，可以获取到它用过的方法名称</li>
<li>可以获取到类的实例变量名称，以及打印出实例变量的值，当然也可以修改实例变量的值</li>
<li>能够执行 method swizzling， 替换某个指定的函数</li>
<li>可以在运行时调用其他方法</li>
</ul>
<h4 id="安装_cycript">安装 cycript</h4>
<p>首先利用 Cydia 下载 <code>mobilesubstrate</code> <code>adv-mds</code>;从<a href="www.cycript.org/debs/">官网</a>上面下载最新的包，并通过 <code>scp</code> 把文件拷贝到 iOS 设备上去，利用 <code>dpkg</code> 进行安装：</p>
<pre><code>dpkg -<span class="keyword">i</span> cycript cycript_0.<span class="number">9.102</span>-<span class="number">1</span>_iphoneos-arm.<span class="keyword">deb</span>
</code></pre><p>安装完成之后，执行 cycript 看是否工作：</p>
<h4 id="用Cycript进行实时修改">用Cycript进行实时修改</h4>
<p>本文将使用支付宝来进行测试。</p>
<ul>
<li>让支付宝钱包在前台运行，并找出它的进程id，然后用 cycript -p hook 进程</li>
</ul>
<pre><code>    chengpeide-iPhone:~ root<span class="preprocessor"># ps aux | grep AlipayWallet</span>
    mobile     <span class="number">629</span>   <span class="number">0.0</span>  <span class="number">9.3</span>   <span class="number">815836</span>  <span class="number">47792</span>   ??  Ss    <span class="number">9</span>:<span class="number">45</span>PM   <span class="number">0</span>:<span class="number">34.79</span> /var/mobile/Containers/Bundle/Application/FB2E1466-<span class="number">0</span>D87-<span class="number">4</span>FF9-<span class="number">9616</span>-BD4269D61BCF/AlipayWallet<span class="variable">.app</span>/AlipayWallet
    root       <span class="number">678</span>   <span class="number">0.0</span>  <span class="number">0.1</span>   <span class="number">536256</span>    <span class="number">412</span> s000  U+    <span class="number">9</span>:<span class="number">49</span>PM   <span class="number">0</span>:<span class="number">00.01</span> grep AlipayWallet

    -rwxr-xr-x <span class="number">1</span> root admin <span class="number">906</span> Jan <span class="number">12</span>  <span class="number">2015</span> cycript
    chengpeide-iPhone:/cp/Cycript_0<span class="number">.9</span><span class="number">.502</span> root<span class="preprocessor"># cycript -p 629</span>

    cy<span class="preprocessor"># var app = [UIApplication sharedApplication]</span>
    <span class="preprocessor">#<span class="title">"&lt;DFApplication: 0x14df44d0&gt;"</span></span>
    cy<span class="preprocessor"># app.delegate</span>
    <span class="preprocessor">#<span class="title">"&lt;DFClientDelegate: 0x14ed2d40&gt;"</span></span>
    cy<span class="preprocessor"># app.keyWindow.rootViewController</span>
    <span class="preprocessor">#<span class="title">"&lt;DFNavigationController: 0x15ac9a00&gt;"</span></span>
    cy<span class="preprocessor"># var nav = new Instance(0x15ac9a00)</span>
    <span class="preprocessor">#<span class="title">"&lt;DFNavigationController: 0x15ac9a00&gt;"</span></span>
    cy<span class="preprocessor"># nav.topViewController.childViewControllers</span>
    @[<span class="preprocessor">#<span class="title">"&lt;HPHomeWidgetGroup: 0x160a03d0&gt;"</span>,#<span class="title">"&lt;O2OIndexViewController: 0x15ad6600&gt;"</span>,#<span class="title">"&lt;APContactRecentViewController: 0x15afb600&gt;"</span>,#<span class="title">"&lt;WWAssetsViewController: 0x160a9da0&gt;"</span>]</span>
    cy<span class="preprocessor"># var assetsViewController = new Instance(0x160a9da0)</span>
    <span class="preprocessor">#<span class="title">"&lt;WWAssetsViewController: 0x160a9da0&gt;"</span></span>
    cy<span class="preprocessor"># [assetsViewController.view subviews]</span>
    @[<span class="preprocessor">#<span class="title">"&lt;UIView: 0x162d8000; frame = (0 0; 0 0); layer = &lt;CALayer: 0x162c85d0&gt;&gt;"</span>,#<span class="title">"&lt;UITableView: 0x15433800; frame = (0 0; 320 519); clipsToBounds = YES; gestureRecognizers = &lt;NSArray: 0x1623d1f0&gt;; layer = &lt;CALayer: 0x162c3b10&gt;; contentOffset: {0, -64}; contentSize: {320, 800}&gt;"</span>]</span>
    cy<span class="preprocessor"># var tableView = new Instance (0x15433800)</span>
    <span class="preprocessor">#<span class="title">"&lt;UITableView: 0x15433800; frame = (0 0; 320 519); clipsToBounds = YES; gestureRecognizers = &lt;NSArray: 0x1623d1f0&gt;; layer = &lt;CALayer: 0x162c3b10&gt;; contentOffset: {0, -42}; contentSize: {320, 800}&gt;"</span></span>
    cy<span class="preprocessor"># tableView.backgroundColor = [UIColor redColor]</span>
    <span class="preprocessor">#<span class="title">"UIDeviceRGBColorSpace 1 0 0 1"</span></span>

    [tableView visibleCells]
    @[<span class="preprocessor">#<span class="title">"&lt;HeadInfoCell: 0x16160a40; baseClass = UITableViewCell; frame = (0 220; 320 80); autoresize = W; layer = &lt;CALayer: 0x16160e80&gt;&gt;"</span>,#<span class="title">"&lt;DoubleInfoCell: 0x1569e800; baseClass = UITableViewCell; frame = (0 300; 320 80); autoresize = W; layer = &lt;CALayer: 0x16486e80&gt;&gt;"</span>,#<span class="title">"&lt;DoubleInfoCell: 0x15452e00; baseClass = UITableViewCell; frame = (0 380; 320 80); autoresize = W; layer = &lt;CALayer: 0x16491a50&gt;&gt;"</span>]</span>
    cy<span class="preprocessor"># var headCell = new Instance (0x16160a40)</span>
    <span class="preprocessor">#<span class="title">"&lt;HeadInfoCell: 0x16160a40; baseClass = UITableViewCell; frame = (0 220; 320 80); autoresize = W; layer = &lt;CALayer: 0x16160e80&gt;&gt;"</span></span>
    cy<span class="preprocessor"># headCell.backgroundColor = [UIColor redColor]</span>
    <span class="preprocessor">#<span class="title">"UIDeviceRGBColorSpace 1 0 0 1"</span></span>
    cy<span class="preprocessor"># headCell.contentView.backgroundColor = [UIColor redColor]</span>
    <span class="preprocessor">#<span class="title">"UIDeviceRGBColorSpace 1 0 0 1"</span></span>
</code></pre><p>我们可以看到，界面上 tableViewCell 的背景颜色变成了红色。</p>
<p><img src="http://cp0000.github.io/assets/blue.PNG" alt="shortcut2"></p>
<p>以上操作的思路大致就是， appdelegate =&gt; keyWindow =&gt; rootViewController =&gt; viewControllers =&gt; view </p>
<p>当然你也可以骗骗自己，把余额这个label的text改成巨款，过过眼瘾</p>
<pre><code>    cy<span class="special">#</span> <span class="special">[</span>tableView subviews<span class="special">]</span>
    @<span class="special">[</span><span class="special">#</span>"&lt;UIRefreshControl: 0x16482c90; frame = (0 0; 320 60); hidden = YES; autoresize = W; layer = &lt;CALayer: 0x16256370&gt;&gt;",<span class="special">#</span>"&lt;UITableViewWrapperView: 0x1624cce0; frame = (0 0; 320 519); gestureRecognizers = &lt;NSArray: 0x16098960&gt;; layer = &lt;CALayer: 0x14e12cf0&gt;; contentOffset: <span class="special">{</span>0, 0<span class="special">}</span>; contentSize: <span class="special">{</span>320, 519<span class="special">}</span>&gt;",<span class="special">#</span>"&lt;UIView: 0x16216d10; frame = (0 780; 320 20); layer = &lt;CALayer: 0x162562c0&gt;&gt;",<span class="special">#</span>"&lt;WHAccountHeaderView: 0x16217c10; frame = (0 0; 320 180); layer = &lt;CALayer: 0x1637edd0&gt;&gt;",<span class="special">#</span>"&lt;UIView: 0x17635b80; frame = (0 180; 320 40); autoresize = W; layer = &lt;CALayer: 0x1620d670&gt;&gt;",<span class="special">#</span>"&lt;UIImageView: 0x161f4740; frame = (0 452.5; 320 2.5); alpha = 0; opaque = NO; autoresize = TM; userInteractionEnabled = NO; layer = &lt;CALayer: 0x161f47c0&gt;&gt;"<span class="special">]</span>
    cy<span class="special">#</span> var header = new Instance(0x16217c10)
    <span class="special">#</span>"&lt;WHAccountHeaderView: 0x16217c10; frame = (0 0; 320 180); layer = &lt;CALayer: 0x1637edd0&gt;&gt;"
    cy<span class="special">#</span> <span class="special">[</span>header subviews<span class="special">]</span>
    @<span class="special">[</span><span class="special">#</span>"&lt;UIView: 0x161c6530; frame = (0 0; 320 117); layer = &lt;CALayer: 0x1638a780&gt;&gt;",<span class="special">#</span>"&lt;UIView: 0x16142d70; frame = (0 117.5; 106.667 62.5); layer = &lt;CALayer: 0x161f6350&gt;&gt;",<span class="special">#</span>"&lt;UIView: 0x16142de0; frame = (106.667 117.5; 106.667 62.5); layer = &lt;CALayer: 0x16109ed0&gt;&gt;",<span class="special">#</span>"&lt;UIView: 0x1610a4b0; frame = (213.333 117.5; 106.667 62.5); layer = &lt;CALayer: 0x163771b0&gt;&gt;",<span class="special">#</span>"&lt;UILabel: 0x161082c0; frame = (122 28; 76 41); text = '0.00'; userInteractionEnabled = NO; layer = &lt;_UILabelLayer: 0x14f73520&gt;&gt;",<span class="special">#</span>"&lt;UIImageView: 0x1610a520; frame = (246 42; 9 13); opaque = NO; userInteractionEnabled = NO; layer = &lt;CALayer: 0x161025c0&gt;&gt;",<span class="special">#</span>"&lt;UIImageView: 0x161692b0; frame = (56.5 83; 13 13); opaque = NO; userInteractionEnabled = NO; layer = &lt;CALayer: 0x16169330&gt;&gt;",<span class="special">#</span>"&lt;UILabel: 0x16169380; frame = (74.5 83; 189 13); text = '<span class="command">\xe</span>7<span class="command">\x</span>82<span class="command">\xb</span>9<span class="command">\xe</span>6<span class="command">\xad</span><span class="command">\xa</span>4<span class="command">\xe</span>5<span class="command">\xbc</span><span class="command">\x</span>80<span class="command">\xe</span>5<span class="command">\x</span>90<span class="command">\xaf</span><span class="command">\xe</span>8<span class="command">\xb</span>4<span class="command">\xa</span>6<span class="command">\xe</span>6<span class="command">\x</span>88<span class="command">\xb</span>7<span class="command">\xe</span>5<span class="command">\xae</span><span class="command">\x</span>89<span class="command">\xe</span>5<span class="command">\x</span>85<span class="command">\xa</span>8<span class="command">\xe</span>9<span class="command">\x</span>99<span class="command">\xa</span>9<span class="command">\xef</span><span class="command">\xbc</span><span class="command">\x</span>8c<span class="command">\xe</span>4<span class="command">\xba</span><span class="command">\xab</span>100<span class="command">\xe</span>4<span class="command">\xb</span>8<span class="command">\x</span>87<span class="command">\xe</span>4<span class="command">\xbf</span><span class="command">\x</span>9d<span class="command">\xe</span>9<span class="command">\x</span>9a<span class="command">\x</span>9c'; userInteractionEnabled = NO; layer = &lt;_UILabelLayer: 0x16169230&gt;&gt;",<span class="special">#</span>"&lt;UILabel: 0x16169570; frame = (36.8333 154.25; 33 12); text = '<span class="command">\xe</span>9<span class="command">\x</span>93<span class="command">\xb</span>6<span class="command">\xe</span>8<span class="command">\xa</span>1<span class="command">\x</span>8c<span class="command">\xe</span>5<span class="command">\x</span>8d<span class="command">\xa</span>1'; userInteractionEnabled = NO; layer = &lt;_UILabelLayer: 0x16169630&gt;&gt;",<span class="special">#</span>"&lt;UILabel: 0x16169810; frame = (48.3333 131.25; 10 17); text = '2'; userInteractionEnabled = NO; layer = &lt;_UILabelLayer: 0x161698d0&gt;&gt;",<span class="special">#</span>"&lt;UIImageView: 0x16169ab0; frame = (42.3333 127.25; 22 22); hidden = YES; opaque = NO; userInteractionEnabled = NO; layer = &lt;CALayer: 0x16169b30&gt;&gt;",<span class="special">#</span>"&lt;UILabel: 0x16381200; frame = (149 154.25; 22 12); text = '<span class="command">\xe</span>4<span class="command">\xbd</span><span class="command">\x</span>99<span class="command">\xe</span>9<span class="command">\xa</span>2<span class="command">\x</span>9d'; userInteractionEnabled = NO; layer = &lt;_UILabelLayer: 0x16381160&gt;&gt;",<span class="special">#</span>"&lt;UILabel: 0x16380280; frame = (144 131.25; 32 17); text = '0.00'; userInteractionEnabled = NO; layer = &lt;_UILabelLayer: 0x16380340&gt;&gt;",<span class="special">#</span>"&lt;UILabel: 0x16380520; frame = (255.667 154.25; 22 12); text = '<span class="command">\xe</span>5<span class="command">\x</span>8d<span class="command">\xa</span>1<span class="command">\xe</span>5<span class="command">\x</span>8c<span class="command">\x</span>85'; userInteractionEnabled = NO; layer = &lt;_UILabelLayer: 0x163805e0&gt;&gt;",<span class="special">#</span>"&lt;UILabel: 0x1638d640; frame = (261.667 131.25; 10 17); text = '0'; userInteractionEnabled = NO; layer = &lt;_UILabelLayer: 0x1638d700&gt;&gt;",<span class="special">#</span>"&lt;UIView: 0x16151570; frame = (0 117; 320 0.5); layer = &lt;CALayer: 0x161515e0&gt;&gt;",<span class="special">#</span>"&lt;UIView: 0x16151670; frame = (0 179.5; 320 0.5); layer = &lt;CALayer: 0x161516e0&gt;&gt;"<span class="special">]</span>
    cy<span class="special">#</span> var label2= new Instance(0x161082c0)
    <span class="special">#</span>"&lt;UILabel: 0x161082c0; frame = (122 28; 76 41); text = '0.00'; userInteractionEnabled = NO; layer = &lt;_UILabelLayer: 0x14f73520&gt;&gt;"
    cy<span class="special">#</span> label2.text=@"10000000000000"
    @"10000000000000"
</code></pre><p><img src="http://cp0000.github.io/assets/rich.PNG" alt="shortcut2"></p>
<p>很好玩，也很有用的工具，cycript。当然cycript还有一些高级用法，后面会介绍。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/11/30/iOS-reverse-engineering-02/" data-id="kdo076sc5ai5ybug" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS-Reverse-Engineering/">iOS Reverse Engineering</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-iOS-reverse-engineering-01" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2015/11/21/iOS-reverse-engineering-01/">iOS逆向工程-0x00－用途以及准备工作</a>
  

      </header>
    
    <time class="article-date" datetime="2015-11-21T02:46:07.000Z" itemprop="datePublished">11-21-2015</time>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Tech/">Tech</a>
  </div>

  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言">前言</h2>
<p>好奇心，求知欲，是作为一个程序员很重要的属性。好奇心会促使你去了解那些未知的事物，打开新的世界。求知欲则帮助你去琢磨这些知识，探索这些事物是如何工作的。</p>
<p>作为一个iOS开发者，我在使用其他开发者的优秀app的时候，总是会去猜测作者是怎么实现这个功能的，换作是我，我会怎么去实现它。有些功能很容易猜测出来（如微信iOS app的总体结构，想一下也会知道它的结构是 tabbarController+navigationController+tableViewController）；有些功能就不容易从表面上猜测出来，如博客软件 Castro。要想知道这些软件的一些设计细节，就得用上逆向工程，来帮助我们获取到想要的信息。</p>
<p>当然了，逆向工程还有其他更重要的用途，如下：</p>
<ul>
<li>分析恶意软件</li>
<li>安全研究</li>
<li>借鉴别人的软件</li>
<li>破解使用限制</li>
</ul>
<h2 id="准备工作">准备工作</h2>
<p>在开始 iOS 逆向工作之前，得准备一下相关设备</p>
<h3 id="硬件">硬件</h3>
<ul>
<li>Mac 电脑</li>
<li>一台越狱机器 (如何越狱，请访问 <strong><a href="http://pangu.io/" target="_blank" rel="external">pangu</a></strong>)</li>
</ul>
<h3 id="设置环境">设置环境</h3>
<h4 id="利用Cydia安装相关开发工具，建议安装下表中的全部软件">利用<code>Cydia</code>安装相关开发工具，建议安装下表中的全部软件</h4>
<table>
<thead>
<tr>
<th>tool</th>
<th>description </th>
</tr>
</thead>
<tbody>
<tr>
<td>ps</td>
<td>process status, cpu usage, memory usage</td>
</tr>
<tr>
<td>sysctl</td>
<td>get or set kernal state</td>
</tr>
<tr>
<td>netstat</td>
<td>show network status</td>
</tr>
<tr>
<td>route</td>
<td>manually manipulate the routing tables</td>
</tr>
<tr>
<td>renice</td>
<td>alter priority of running processes</td>
</tr>
<tr>
<td>ifconfig</td>
<td>configure network interface parameters</td>
</tr>
<tr>
<td>tcpdump</td>
<td>dump traffic on a network</td>
</tr>
<tr>
<td>lsof</td>
<td>list open files</td>
</tr>
<tr>
<td>otool</td>
<td>displays specified parts of object files or libraries.</td>
</tr>
<tr>
<td>nm</td>
<td>displays the name list (symbol table) of each object file in the argument list.</td>
</tr>
<tr>
<td>ldid</td>
<td>signature tool</td>
</tr>
<tr>
<td>gdb</td>
<td>debug tool</td>
</tr>
<tr>
<td>lldb</td>
<td>debug tool</td>
</tr>
<tr>
<td>patch</td>
<td>patch tool</td>
</tr>
<tr>
<td>SSH</td>
<td>is a program for logging into a remote machine and for executing commands on a remote machine.</td>
</tr>
</tbody>
</table>
<h4 id="SSH_to_iPhone">SSH to iPhone</h4>
<h5 id="通过_wifi">通过 wifi</h5>
<pre><code><span class="title">ssh</span> root<span class="variable">@your</span>.iphone.ip
</code></pre><p>iOS 系统中的<code>root</code>用户的默认密码是 <code>Alipne</code>.第一次登录的时候请使用这个密码。不过请记得修改<code>root</code>用户的密码，不然这台越狱机器就很不安全了。</p>
<p><strong>修改用户密码</strong></p>
<pre><code>iPhone:~ root<span class="comment"># passwd</span>
Changing password <span class="keyword">for</span> root
<span class="keyword">New</span> password:
Retype <span class="keyword">new</span> password:
iPhone:~ root<span class="comment">#</span>
</code></pre><h5 id="通过_usb">通过 usb</h5>
<p>在wifi不稳定的场景下，建议使用usb来ssh到iPhone上。（我自己也是主要适用usb来进行ssh）</p>
<ul>
<li><p>关于如何使用 usb ssh 到 iPhone上，详情请访问网页 <a href="http://iphonedevwiki.net/index.php/SSH_Over_USB" target="_blank" rel="external">SSH over USB</a>。根据网页上面的guide，需要下载：<a href="https://code.google.com/p/iphonetunnel-usbmuxconnectbyport/downloads/detail?name=itnl_rev8.zip" target="_blank" rel="external">itnl_rev8.zip</a></p>
</li>
<li><p>解压zip包之后，做如下操作：</p>
<ul>
<li><p>OS X terminal:</p>
<pre><code>  <span class="comment">sudo</span> <span class="comment">path/to/itnl</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">iport</span> <span class="comment">22</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">lport</span> <span class="comment">2222</span>
</code></pre></li>
<li><p>iPhone terminal:</p>
<pre><code>  <span class="title">ssh</span> -p <span class="number">2222</span> root<span class="variable">@localhost</span>
</code></pre></li>
</ul>
</li>
</ul>
<p>然后，就成功 ssh 到 iPhone 上面。我们的准备工作到此也就做完了，接下来我们就可以开始逆向 iOS app了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/11/21/iOS-reverse-engineering-01/" data-id="gu67jirj3v2wa3kr" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS-Reverse-Engineering/">iOS Reverse Engineering</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-27" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2015/10/27/27/">活到二十七</a>
  

      </header>
    
    <time class="article-date" datetime="2015-10-26T16:05:53.000Z" itemprop="datePublished">10-27-2015</time>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Life/">Life</a>
  </div>

  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>“Many people die at 25 and aren’t buried until 75.”(很多人25岁就死了，但是要75岁才被埋进土里)－－这是美国政治家，科学家富兰克林的名句。</p>
</blockquote>
<p>这里的死当然不是生理上的死亡，我的理解是指一个人的生活进入了静止的状态；早上8点起床，吃着相同的早餐，走着每天上下班的路去公司，开始一天忙碌的办公司生活，日复一日，循环至死。</p>
<p>今天是我二七岁的生日，想来我自己不也是如此嘛？每天的日子趋于静止，今天像是昨天的拷贝。</p>
<p>稍微观察下，生活中大家见面的时候，都会寒暄一句“最近在忙啥？”。想来这句话却很有意思，它鲜活的表现出了我们是一个好像不忙点啥，日子就没法过下去的种族。也是，我们身边的每个人每天都显得很忙；大家忙着挣钱，忙着找女人，忙着玩游戏，忙着去八卦，忙着娱乐，一刻都不得闲；但其实我觉得是人们害怕闲。因为一当闲下来，我们会不知道干嘛，进而觉得无聊，产生厌烦，最后感到孤独。</p>
<p>我也是如此，为了让自己忙起来，我写博客，不停的往Wunderlist中加todos，看amazon上面的畅销书。坦白讲，长长的 TODO list 会让我产生一种心安。</p>
<p>记得大二的时候，当时的我，一个中二青年，被乔布斯在斯坦福大学上的毕业演讲的震撼住了。其中有一段是</p>
<blockquote>
<p>Your work is going to fill a large part of your life, and the only way to be truly satisfied is to do what you believe is great work. And the only way to do great work is to love what you do. If you haven’t found it yet, keep looking. Don’t settle. As with all matters of the heart, you’ll know when you find it. </p>
</blockquote>
<p>这么些年来，我一直被这个演讲所影响。我会时常问自己，到底想要成为什么样子的人，真正想要做的事情是什么。但在27岁生日这天，我不得不承认，我还是没有找到。有段时间，在做 reverse engineering 的时候，我的确遇到了那种 “啊哈” 时刻。但当我深入进去之后，了解业界专业的安全知识之后，我知道这东西是需要天分加大量的练习，可惜我不够，天分和练习都不够。而且我也没有豁出去，重新来过的勇气。</p>
<p>或许是年纪的增长，近些日子，我会开始关注房子，汽车等诸如此类的事物。有时候我也想给自己弄个窝，不用寄人篱下，活得体面一点。这诺大的城市中，我也不想一直是那个漂泊的，东奔西跑的人。但高企的房价，不可理喻的限购政策又让我心灰意冷，不知出路在何处。</p>
<p>只希望二十八的时候，自己晚上洗完澡倒头上床，盯着天花板的时候，知道自己到底在忙些什么。</p>
<p><a href="http://music.163.com/#/song?id=28349599" target="_blank" rel="external">Johnny and Mary (Feat. Bryan Ferry)</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/10/27/27/" data-id="yy3wdzmdr7fgt694" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Peek-and-pop" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2015/10/25/Peek-and-pop/">3D-Touch(2) PEEK And POP</a>
  

      </header>
    
    <time class="article-date" datetime="2015-10-25T02:36:21.000Z" itemprop="datePublished">10-25-2015</time>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Tech/">Tech</a>
  </div>

  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p>如上篇文章所说，3D Touch 主要分成三个模块： Home Actions, Peek &amp; Pop, Force Properties。上篇文章中总结了 Home Actions的相关知识点以及如何接入该功能。本文将用来介绍Peek &amp; Pop 的相关知识点。</p>
<p>在给你的app接入peeking and poping 的功能之前，需要先了解该操作的三个属性， peeking, preview actions, poping。如下图所示：</p>
<p><img src="http://cp0000.github.io/assets/peekandpop.gif" alt="peek_and_pop"></p>
<p>用户在 Peeking 图片，视频，网页等内容的时候，能够在不去加载全部内容的情况下获取到更多详细的内容。</p>
<h2 id="PEEKING">PEEKING</h2>
<p>当用户对某个view做peeking操作时，程序会展现给用户相对应内容的快照。Peek 操作是 3DTouch 中实现起来相对比较复杂的模块。Peek and Pop API 中有一个 <code>UIViewControllerPreviewingDelegate</code>,给指定的view需要注册这个delegate，就可以接收到系统回调过来的3D Touch事件。</p>
<pre><code>override func viewDidLoad() {
    <span class="keyword">super</span>.viewDidLoad()

    /*  
        Register <span class="keyword">for</span> `<span class="javascript">UIViewControllerPreviewingDelegate</span>` to enable
        <span class="string">"Peek"</span> <span class="keyword">and</span> <span class="string">"Pop"</span>.
        The view controller will be automatically unregistered <span class="keyword">when</span> it <span class="keyword">is</span>
        deallocated.
    */
    registerForPreviewingWithDelegate(self, <span class="attribute">sourceView</span>: view)
}
</code></pre><p>这里有一点需要注意，我们可以在一个 view Controller 中，给多个view注册 Previewing Delegate ，但是我们不能反复去注册同一个view。</p>
<blockquote>
<p>“You can designate more than one source view for a single registered view controller, but you cannot designate a single view as a source view more than once.”</p>
</blockquote>
<p>Peek的操作过程可以分解成下面三个步骤：</p>
<p><img src="http://cp0000.github.io/assets/peek_and_pop2.png" alt="peek_and_pop_2"></p>
<p>Peek的系统回调函数会提供一个关于 source view的context，以及 touch事件的point。以sourceView为 collectionView为例，回调函数中我们需要处理以下三件事情：</p>
<ul>
<li>(1) 根据 location 找到被 peeked 的 cell，以及cell的 NSIndexPath</li>
<li>(2) 设置 previewingContext 的 sourceRect 大小</li>
<li>(3) alloc 一个 PreViewController，并设置背景图片，title之类的， 然后返回这个 PreviewController</li>
</ul>
<p><strong>UICOLLECTIONVIEW 代码片段</strong></p>
<pre><code><span class="keyword">override</span> <span class="func"><span class="keyword">func</span></span> viewDidLoad() {
    <span class="keyword">super</span>.viewDidLoad()

    registerForPreviewingWithDelegate(<span class="keyword">self</span>, sourceView: tableView)
}

<span class="func"><span class="keyword">func</span></span> previewingContext(previewingContext: <span class="type">UIViewControllerPreviewing</span>, viewControllerForLocation location: <span class="type">CGPoint</span>) -&gt; <span class="type">UIViewController</span>? {
    guard <span class="keyword">let</span> indexPath = collectionView?.indexPathForItemAtPoint(location) <span class="keyword">else</span> { <span class="keyword">return</span> <span class="built_in">nil</span> }

    guard <span class="keyword">let</span> cell = collectionView?.cellForItemAtIndexPath(indexPath) <span class="keyword">else</span> { <span class="keyword">return</span> <span class="built_in">nil</span> }

    guard <span class="keyword">let</span> detailVC = storyboard?.instantiateViewControllerWithIdentifier(<span class="string">"DetailViewController"</span>) <span class="keyword">as</span>? <span class="type">DetailViewController</span> <span class="keyword">else</span> { <span class="keyword">return</span> <span class="built_in">nil</span> }

    <span class="keyword">let</span> photo = photos[indexPath.row]
    detailVC.photo = photo

    detailVC.preferredContentSize = <span class="type">CGSize</span>(width: <span class="number">0.0</span>, height: <span class="number">300</span>)

    previewingContext.sourceRect = cell.frame

    <span class="keyword">return</span> detailVC
}
</code></pre><h2 id="UIPREVIEWACTIONITEMS">UIPREVIEWACTIONITEMS</h2>
<p>当用户在 PreViewing Controller 的界面，手指往上推，会从屏幕底部弹出一个类似 actionsheet 的界面，这个是 <code>UIPreviewActions</code>。那如何给指定的 preViewController 自定义这些 <code>UIPreviewActions</code>？ 方法很简单，override UIViewController 中的 preViewActionItems() 方法，在该方法中定义好 actionItems 的数组就好了：</p>
<pre><code>override func previewActionItems<span class="function"><span class="params">()</span> -&gt;</span> [UIPreviewActionItem] {

    <span class="reserved">let</span> likeAction = UIPreviewAction<span class="function"><span class="params">(title: <span class="string">"Like"</span>, style: .Default)</span> { <span class="params">(action, viewController)</span> -&gt;</span> Void <span class="keyword">in</span>
        <span class="built_in">print</span>(<span class="string">"You liked the photo"</span>)
    }

    <span class="reserved">let</span> deleteAction = UIPreviewAction<span class="function"><span class="params">(title: <span class="string">"Delete"</span>, style: .Destructive)</span> { <span class="params">(action, viewController)</span> -&gt;</span> Void <span class="keyword">in</span>
        <span class="built_in">print</span>(<span class="string">"You deleted the photo"</span>)
    }

    <span class="reserved">let</span> groupAction = UIPreviewActionGroup (<span class="attribute">title</span>: <span class="string">"Group"</span>, <span class="attribute">style</span>: .Default, <span class="attribute">actions</span>: [likeAction, deleteAction])
    <span class="keyword">return</span> [likeAction, deleteAction, groupAction]

}
</code></pre><p>另外苹果还提供了 <code>UIPreviewActionGroup</code>，顾名思义就是把几个UIPreviewActionItem操作放到一起，组成一个组。</p>
<h2 id="POPPING">POPPING</h2>
<p>poping 操作处理起来相对简单。在回调函数中</p>
<pre><code><span class="func"><span class="keyword">func</span></span> previewingContext(previewingContext: <span class="type">UIViewControllerPreviewing</span>, commitViewController viewControllerToCommit: <span class="type">UIViewController</span>) {
    <span class="comment">//Here's where you commit (pop)</span>
}
</code></pre><p>我们需要根据preViewingContext来确定poping的时候需要commit的ViewController就好了。</p>
<h2 id="WEBVIEW_PEEK_AND_POP">WEBVIEW PEEK AND POP</h2>
<p>让 <code>UIWebView</code> 和 <code>WKWebview</code> 支持 Peek&amp;Pop就很简单了：</p>
<pre><code>webView.<span class="variable">allowsLinkPreview =</span> <span class="constant">true</span>
</code></pre><h2 id="结语">结语</h2>
<p>以上。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/10/25/Peek-and-pop/" data-id="abddbn5yyno0n58f" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-iOS9-Quick-Actions-shortcut" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2015/09/30/iOS9-Quick-Actions-shortcut/">3D-Touch(1) iOS9 Quick Actions Shortcut</a>
  

      </header>
    
    <time class="article-date" datetime="2015-09-30T11:24:13.000Z" itemprop="datePublished">09-30-2015</time>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Tech/">Tech</a>
  </div>

  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p>新的iPhone6s, iPhone6s P 在不久之前的 WWDC 上面发布了，这个版本的iPhone最大的卖点应该是在它的屏幕拥有了 3D Touch 的功能。iOS 9 中已经包含了这一硬件功能所提供API，3D Touch API分成三个部分: Quick Actions， peek and pop,以及 Pressure Sensitivity.考虑到苹果的一贯作风，如果你的APP中集成iPhone的新特性，新的API，被苹果商店推荐的概率也会增大一点。本文将为大家介绍如何快速的添加 Quick Actions shortcut 功能。</p>
<h2 id="Home_Screen_Quick_Actions">Home Screen Quick Actions</h2>
<p>通过主屏幕的应用icon，可以用 3D Touch 呼出一个快捷列表，用户可通过这个列表快速定位应用功能模块。iOS9提供了两种屏幕标签，分别是静态标签和动态标签。且iOS9最多展示四个快捷键给用户，系统会优先展示静态的快捷键，当静态的快捷键不够四个，会添加动态的快捷键到列表。</p>
<h3 id="静态快捷键的添加">静态快捷键的添加</h3>
<p>打开 Info.plist, 在该文件中添加如下键值：</p>
<p><img src="http://cp0000.github.io/assets/static_shortcut.jpg" alt="static_shortcut"></p>
<p>添加一个key为<code>UIApplicationShortcutItems</code>的数组，数组中添件的元素就是静态标签，每个标签我们可以配置下面的键值：</p>
<ul>
<li>UIApplicationShortcutItemType (required) : 快捷标签的唯一字符串标示</li>
<li>UIApplicationShortcutItemTitle (required): 快捷标签的标题，会显示在UI上</li>
<li>UIApplicationShortcutItemSubtitle (optional): 副标题，会显示在UI上</li>
<li>UIApplicationShortcutItemIconType (optional): 系统提供的icon，全部列表 <a href="https://developer.apple.com/library/prerelease/ios/documentation/UIKit/Reference/UIApplicationShortcutIcon_Class/index.html#//apple_ref/c/tdef/UIApplicationShortcutIconType" target="_blank" rel="external">UIApplicationShortcutIcon_Class</a></li>
<li>UIApplicationShortcutItemIconFile (optional): 自定义icon（如果填写了该项，则系统自动ignore UIApplicationShortcutItemIconType）。图片需要时正方形的，35<em>35的倍数（试过100</em>100也是Ok的），并且单色。</li>
<li>UIApplicationShortcutItemUserInfo (optional): 传值用</li>
</ul>
<p>详情请<a href="https://developer.apple.com/library/prerelease/ios/documentation/General/Reference/InfoPlistKeyReference/Articles/iPhoneOSKeys.html#//apple_ref/doc/uid/TP40009252-SW36" target="_blank" rel="external">看这里</a></p>
<p>当在Info.plist 中添加好了需要的标签之后。运行程序便可得到以下效果：</p>
<p><img src="http://cp0000.github.io/assets/shortcut2.jpg" alt="shortcut2"></p>
<p>P.S 关于如何在模拟器中调试ShortCutMenu，请见文章最后一节<a href="#jump">模拟器上测试Shortcut</a>。</p>
<h3 id="动态标签的添加">动态标签的添加</h3>
<p>所谓动态标签，就是我们可以通过代码来添加标签，相关的类有：</p>
<ul>
<li>UIApplicationShortcutItem 3DTouch标签的类</li>
<li>UIApplicationShortcutIcon 标签中图片Icon的类</li>
</ul>
<h3 id="响应标签的行为">响应标签的行为</h3>
<p>当点击标签进入应用时，我们需要在代码对不同标签的做处理。在iOS 9 中，UIApplicationDelegate 新增了方法：</p>
<pre><code><span class="pp">- <span class="params">(void)</span> application:<span class="params">(<span class="variable">UIApplication</span> *)</span>application performActionForShortcutItem:<span class="params">(<span class="variable">UIApplicationShortcutItem</span> *)</span>shortcutItem completionHandler:<span class="params">(void (^)</span><span class="params">(<span class="variable">BOOL</span>)</span>)completionHandler</span>
</code></pre><p>当通过标签进入APP时，appdelegate中会回调到这个函数。当你处理完了标签需要做的工作之后，需要执行 <code>completionHandler</code>。</p>
<p>这里有一个地方需要特别注意一下，用户按下标签进入应用要分成两种状况：启动APP，APP从后台回到前台。你需要在 <code>application:didFinishLaunchingWithOptions:</code> 或 <code>application:willFinishLaunchingWithOptions:</code> 中的一个去检查字典 <code>launchOptions</code> 中是否包含了<code>UIApplicationLaunchOptionsShortcutItemKey</code>。如果有这个key，则表示是启动app。你需要在此时设置好APP的view层级，并且为 application:willFinishLaunchingWithOptions: 返回 false。这样就可以阻止 <code>application(_:performActionForShortcutItem:completionHandler:)</code> 被调用，避免标签处理逻辑被处理两次。</p>
<p>以下是 sample code (Objective_c)，demo 放在github上面<a href="https://github.com/cp0000/shortcutDemo" target="_blank" rel="external">shortcutDemo</a></p>
<p>另外苹果官方提供了 swift 的<a href="https://developer.apple.com/library/prerelease/ios/samplecode/ApplicationShortcuts/Introduction/Intro.html" target="_blank" rel="external">sample code</a></p>
<pre><code><span class="preprocessor">#import <span class="title">"AppDelegate.h"</span></span>

<span class="class"><span class="keyword">@interface</span> <span class="title">AppDelegate</span> ()</span>
<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, retain) UIApplicationShortcutItem * launchedShortcutItem;

<span class="keyword">@end</span>

<span class="class"><span class="keyword">@implementation</span> <span class="title">AppDelegate</span></span>

- (<span class="built_in">BOOL</span>) handledShortCutItem: (UIApplicationShortcutItem *) shortcutItem
{
    <span class="built_in">BOOL</span> handled = <span class="literal">NO</span>;
    <span class="keyword">if</span> (!shortcutItem<span class="variable">.type</span>) <span class="keyword">return</span> <span class="literal">NO</span>;
    <span class="keyword">if</span> (![shortcutItem<span class="variable">.type</span> isKindOfClass:[<span class="built_in">NSString</span> class]]) <span class="keyword">return</span> <span class="literal">NO</span>;

    UIAlertController * alertController = [UIAlertController alertControllerWithTitle:<span class="string">@"Shortcut Handled"</span> message:shortcutItem<span class="variable">.localizedTitle</span> preferredStyle: UIAlertControllerStyleAlert];
    UIAlertAction *alertAction = [UIAlertAction actionWithTitle:<span class="string">@"OK"</span> style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
    }];
    [alertController addAction: alertAction];

    [<span class="keyword">self</span><span class="variable">.window</span><span class="variable">.rootViewController</span> presentViewController: alertController animated: <span class="literal">YES</span> completion:<span class="literal">nil</span>];

    <span class="keyword">return</span> handled;
}

- (<span class="built_in">BOOL</span>)application:(<span class="built_in">UIApplication</span> *)application didFinishLaunchingWithOptions:(<span class="built_in">NSDictionary</span> *)launchOptions {
    <span class="comment">// Override point for customization after application launch.</span>
<span class="comment">//    Dynamic Shortcuts</span>
    UIApplicationShortcutIcon * addIcon = [UIApplicationShortcutIcon iconWithType: UIApplicationShortcutIconTypeAdd];<span class="comment">//Icons should be square, single color,</span>

    UIApplicationShortcutItem * addItem = [[UIApplicationShortcutItem alloc]initWithType: <span class="string">@"add"</span> localizedTitle: <span class="string">@"Add"</span> localizedSubtitle: <span class="literal">nil</span> icon: addIcon userInfo: <span class="literal">nil</span>];

    [<span class="built_in">UIApplication</span> sharedApplication]<span class="variable">.shortcutItems</span> = @[addItem];

    <span class="built_in">BOOL</span> shouldPerformAdditionalDelegateHandling    = <span class="literal">YES</span>;
    <span class="keyword">if</span> (launchOptions[UIApplicationLaunchOptionsShortcutItemKey]) {
        UIApplicationShortcutItem * shortcutItem = launchOptions[UIApplicationLaunchOptionsShortcutItemKey];
        <span class="keyword">self</span><span class="variable">.launchedShortcutItem</span>   = shortcutItem;
        <span class="comment">// This will block "performActionForShortcutItem:completionHandler" from being called.</span>
        shouldPerformAdditionalDelegateHandling     = <span class="literal">NO</span>;
    }
    <span class="keyword">return</span> shouldPerformAdditionalDelegateHandling;
}

- (<span class="keyword">void</span>)applicationWillEnterForeground:(<span class="built_in">UIApplication</span> *)application {
}

- (<span class="keyword">void</span>)applicationDidBecomeActive:(<span class="built_in">UIApplication</span> *)application {
    <span class="keyword">if</span>(!<span class="keyword">self</span><span class="variable">.launchedShortcutItem</span>) {
        <span class="keyword">return</span>;
    }
    [<span class="keyword">self</span> handledShortCutItem: <span class="keyword">self</span><span class="variable">.launchedShortcutItem</span>];

    <span class="keyword">self</span><span class="variable">.launchedShortcutItem</span>   = <span class="literal">nil</span>;
}

- (<span class="keyword">void</span>) application:(<span class="built_in">UIApplication</span> *)application performActionForShortcutItem:(UIApplicationShortcutItem *)shortcutItem completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">BOOL</span>))completionHandler
{
    <span class="built_in">BOOL</span> result = [<span class="keyword">self</span> handledShortCutItem: shortcutItem];
    completionHandler(result);
}

<span class="keyword">@end</span>
</code></pre><p><span id="simulator_shortcuts"></span></p>
<h3 id="模拟器上测试Shortcuts">模拟器上测试Shortcuts</h3>
<p>Xcode7.0 的模拟器是没办法之间触发出 3D Touch 事件的，好在有人开发出了插件<a href="https://github.com/DeskConnect/SBShortcutMenuSimulator" target="_blank" rel="external">SBShortcutMenuSimulator</a>.实用也很简单，只需要follow readme 中的 usage 便可。以下摘录</p>
<pre><code>git clone http<span class="variable">s:</span>//github.<span class="keyword">com</span>/DeskConnect/SBShortcutMenuSimulator.git
<span class="keyword">cd</span> SBShortcutMenuSimulator
<span class="keyword">make</span>

xcrun simctl spawn booted launchctl <span class="keyword">debug</span> <span class="built_in">system</span>/<span class="keyword">com</span>.apple.SpringBoard --environment DYLD_INSERT_LIBRARIES=$PWD/SBShortcutMenuSimulator.dylib
xcrun simctl spawn booted launchctl <span class="keyword">stop</span> <span class="keyword">com</span>.apple.SpringBoard

<span class="keyword">echo</span> <span class="string">'com.apple.mobilecal'</span> | nc <span class="number">127.0</span>.<span class="number">0.1</span> <span class="number">8000</span>
</code></pre><p>‘com.apple.mobilecal’ 替换成你需要测试的app的bundle就可以了，例如我的是 <code>chengpei.shortcutDemo</code></p>
<pre><code><span class="title">echo</span> <span class="string">'chengpei.shortcutDemo'</span> | nc <span class="number">127.0.0.1</span> <span class="number">8000</span>
</code></pre><p>上面的命令全都在clone的SBShortcutMenuSimulator目录下执行。</p>
<h3 id="结语">结语</h3>
<p>以上。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/09/30/iOS9-Quick-Actions-shortcut/" data-id="pxjcxoq4ibyrcaec" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-There-will-be-blood" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2015/09/03/There-will-be-blood/">There Will Be Blood</a>
  

      </header>
    
    <time class="article-date" datetime="2015-09-03T15:47:22.000Z" itemprop="datePublished">09-03-2015</time>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Movie/">Movie</a>
  </div>

  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="http://cp0000.github.io/assets/there_will_be_blood.jpg" alt="pic"></p>
<p>&gt;<br>如果你喜欢《老无所依》，去看《血色将至》<br>如果你喜欢西部片，去看《血色将至》<br>如果你喜欢电影，去看《血色将至》  </p>
<p>电影讲述的是一个银矿勘探者如何通过自身的艰苦奋斗最终成为石油大亨的故事。在观看影片的过程中，主角丹尼尔身上的所表现出来的气质，和我们今天所传扬的创业者身上的气质有着极大相似之处。（当然这些创业者的气质我也是从书中，网络中得来）。其中有两个场景给我映像极其深刻。</p>
<ul>
<li><p>场景一：丹尼尔刚刚开发的新油井发生不幸发生意外，井喷了。丹尼尔的儿子 H.W 在井喷中意外受伤。丹尼尔把受伤的儿子抱到安全地带之后，在明知道儿子因伤至聋，极其需要爸爸的情况下，毅然丢下了儿子，跑去事故现场救灾。当身边的伙伴皱着眉头看着大火的时候，丹尼尔却笑着说：你干嘛要愁眉头，井喷证明了下面埋藏着无穷的石油，我们要发财了。此时，他已经把H.W的情况抛之脑后，心里所想全部是采油的事情。当伙伴问他H.W怎么样了，他才想起来儿子情况很不好。影片此后的镜头就是海报中的场景，丹尼尔指挥者工人用炸药把油井炸封起来。</p>
</li>
<li><p>第二个场景是，为了运输开采出来的石油。丹尼尔决心建一条油管通往大海。但油管铺设遇到了需要通过一块没有弄到租借权的土地。为了能够租下这块地，丹尼尔忍辱负重跑去教堂接受小人Eli神父洗礼。洗礼过程中Eli出于对丹尼尔的嫉妒狠狠的打了几个丹尼尔耳光（个人觉得Eli是在嫉妒丹尼尔，嫉妒他给小镇带来了繁荣，嫉妒他的石油生意）。但此时的丹尼尔并不在意被Eli侮辱，他只在意这块地终于租下来了，石油管道的铺设有谱了，自己的石油生意真的要做起来了。（这里有个细节，在还没有和土地主人谈妥之前，丹尼尔已经在那块地上面打桩测量油管路线。这一情节，也表明了丹尼尔对自己能够说明别人把地租给他的强大自信）</p>
</li>
</ul>
<p>这两个场景都表现出了，丹尼尔对石油开采的极度专注和极大热情。开采过程的任何困难，挫折对于丹尼尔来说都不是问题，井喷不怕，火灾不怕，被小人侮辱无所谓。他眼中只关心和石油相关的事情，他探索油田，建筑油井，铺设油管，一切都是为了自己的石油生意。在生意路上遇到的问题，丹尼尔唯一做的就是自信满满的去解决它。</p>
<p>如果从资本家，企业家的角度来看丹尼尔，他无意是成功创业家的典范。创业后辈们无疑可以从他的事迹中汲取到很多的经验和养分。而他对当地石油的开采，无疑也提高当地人民的生活水平。</p>
<p>但这部电影不是单单讲述一个成功企业家的创业故事，还描述了丹尼尔作为一个人与这个上世界其它人的关系和情感。</p>
<p>我想绝大多数人应该都会害怕孤独吧，开心没人分享，失落无人倾诉。丹尼尔人生就是如此，影片开篇十几分钟跟默片一般，没有一句台词，镜头中只有丹尼尔一个人胡子拉渣的孤独的在矿井中勘探。有了油井，挣了初始资本之后，丹尼尔则每次都会带着H.W去做和卖家谈买卖。美国是一个清教徒国家，大家信上帝，非常重视家庭，大部分都会买亲情的帐。当在H.W变聋之后，为了专注工作，丹尼尔又能冷酷地把儿子从自己身边送走，寄养在别处。不过每个人都渴望亲情，渴望被别人所理解，丹尼尔内心深处也是如此。冒牌弟弟Henry的到来，让他在一段时间好似找到了久违的亲情。但可惜这个Henry是冒牌的，丹尼尔发现真相之后，开枪直接打死了冒牌的Henry，尽管冒牌Henry是唯一能和丹尼尔说得上话的人。</p>
<p>野心，孤独，对权力的欲望，虚伪，憎恶，不信任，丧失人性，这是丹尼尔作为人的一面。但与此同时，他却又是成功的资本家，他成功创业的事迹又会被当今的社会所传颂。或许按中国人的智慧，这就叫是非功过三七开吧。</p>
<p>熙熙皆为利来，攘攘皆为利往。丹尼尔这样的人在当代中国应该很受崇拜吧，应该会。</p>
<p>最后，摘录片中我喜欢的一段台词，也是丹尼尔唯一一次吐露自己心声的一段对话</p>
<p><strong>亨利：</strong><br>　　……你为什么离家出走？我知道你和父亲的关系不好。<br><strong>丹尼尔：</strong><br>　　我替地质调查局工作，去了堪萨斯。<br>　　我没法留在家里，不可能。<br>　　我不喜欢解释自己的行为。<br>　　……<br><strong>丹尼尔：</strong><br>　　你是个愤怒的人吗，亨利？<br><strong>亨利：</strong><br>　　愤怒什么？<br><strong>丹尼尔：</strong><br>　　你嫉妒吗？你会嫉妒别人吗？<br><strong>亨利：</strong><br>　　我想不会。不嫉妒。<br><strong>丹尼尔：</strong><br>　　我有一颗争强好胜的心。<br>　　我不想看到别人成功。<br>　　我憎恨大多数人。<br><strong>亨利：</strong><br>　　我已经没有那种心气了……<br>　　辛苦工作却总不能成功――所有的失败让我……我就不在乎了。<br><strong>丹尼尔：</strong><br>　　我心里有，你心里就也有。<br>　　有时候我注视着人群，看不到任何值得我爱的东西。<br>　　我只想挣到足够的钱好让我远离所有的人。<br>　　……<br><strong>丹尼尔：</strong><br>　　我不想提那些事。<br>　　我看到人们最丑陋的一面，亨利。<br>　　我能得到我所要的一切，根本用不着去看那些丑陋背后还有什么。<br>　　经过这么多年，我的仇恨一点一滴越积越深。<br>　　你来这儿，给了我喘息的机会。我自己一个人坚持不下去……同这些人纠缠。   </p>
<p><strong>英文版</strong></p>
<p><strong>Plainview</strong>: Are you an angry man. Henry?<br><strong>Henry Brands</strong>: About what?<br><strong>Plainview</strong>: Are you envious? D’you get envious?<br><strong>Henry Brands</strong>: I don’t think so. No.<br><strong>Plainview</strong>: I have a competition in me. I want no one else to succeed. I hate most people.<br><strong>Henry Brands</strong>: That part of me is gone. Working and not succeeding- all my, uh… failures has left me, uh… I just don’t… care.<br><strong>Plainview</strong>: Well, if it’s in me, it’s in you. There are times when I… I look at people and I see nothing worth liking. I want to earn enough money I can get away from everyone.<br><strong>Henry Brands</strong>: What will you do about your boy?<br><strong>Plainview</strong>: I don’t know. Uhhhh, maybe it’ll change. Does your sound come back to you? I don’t know. Maybe no one knows that. A doctor might not know that.<br><strong>Henry Brands</strong>: Where’s his mother?<br><strong>Plainview</strong>: I don’t want to talk about those things. I see the worst in people, Henry. I don’t need to look past seeing them to get all I need. I’ve built up my hatreds over the years, little by little. Having you here gives me a second breath of life. I can’t keep doing this on my own… with these, umm… people.   </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/09/03/There-will-be-blood/" data-id="tbvl80afszuynaj6" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-openradarstream" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2015/08/30/openradarstream/">Openradar Stream</a>
  

      </header>
    
    <time class="article-date" datetime="2015-08-30T14:02:42.000Z" itemprop="datePublished">08-30-2015</time>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Tech/">Tech</a>
  </div>

  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="http://cp0000.github.io/assets/radardetector2.jpg" alt="Openradar Stream"></p>
<h4 id="写在前面">写在前面</h4>
<p>随着夏天的结束，9月份的到来，又到了苹果秋季发布新iPhone的季节了。我和绝大多数苹果用户一样对新的iPhone自然保留着一份期待。不过理智告诉我这次新的iPhone的release，应该不会给大家带来很大的惊喜。我猜测 iPhone6s 应该是一款针对 iPhone6 的升级产品。就像 iOS 9 是针对 iOS 8的一次升级，苹果公司内部在这一次的迭代中，主要精力应该是会放在“还债”上，之前release了太多的feature，遗留了太多的bug，会在这一次修复掉。</p>
<h4 id="Openradar_stream_的来由">Openradar stream 的来由</h4>
<p>和大多数 iOS developers 一样，我也在第一时间安装了 iOS 9 beta版本。满足了尝鲜感之后，随着而来就是 beta 系统的不稳定，以及各种的bug。用 iOS 9 进行开发的过程中，我遇到了许许多多的坑，对于一些系统的bug，会花费掉我很多的时间去debug。然后，我发现了<a href="http://www.openradar.appspot.com/" target="_blank" rel="external">openradar</a>。一个 open database of radars for Apple bug。从openradar 上，你可以看到其他开发者提交的bug，这当然会为你省去很多的时间，帮助你避免很多的坑。</p>
<p>后来我想我是不是应该做一个自动的脚本，定时的去抓取这个网页上面的信息，然后发到微博上。关注这个微博的人就可以在自己的时间线上面看到最新的bug了。这样做的好处是，一来你了解到bug信息，下次你遇到类似的问题，会联想到之前看过的bug信息，省去大量的时间。二来，刷微博的时候，还顺便学习了新知识，就没那么大的罪恶感了～。为此，我写一个tiny project，auto radarstream。</p>
<h4 id="具体工作">具体工作</h4>
<p>完成openradarstream，有以下事情需要去做</p>
<p><strong>前期工作</strong></p>
<ul>
<li>申请一个微博账号，并申请微博OpenApi，获取到<code>apikey</code>和<code>apisecret</code>。</li>
<li>获取到微博的 accessToken， expires</li>
</ul>
<p><strong>开发工具</strong></p>
<ul>
<li>language: python</li>
<li>database: sqlite</li>
</ul>
<p><strong>细节</strong></p>
<ul>
<li>设置好微博的环境，其中微博的OpenAPI,使用开源库<a href="https://github.com/michaelliao/sinaweibopy" target="_blank" rel="external">sinaweibopy</a></li>
<li>初始化数据库</li>
</ul>
<pre><code>    <span class="function"><span class="keyword">def</span> <span class="title">initDB</span> <span class="params">()</span>:</span>
        <span class="keyword">print</span> <span class="string">'initDB ...'</span>
        db = sqlite3.connect(sqlite_file)
        cursor = db.cursor()
        cursor.execute(<span class="string">'''CREATE TABLE IF NOT EXISTS
                          bugs(id INTEGER PRIMARY KEY, bugid TEXT, status TEXT, originator TEXT, product TEXT, title TEXT)'''</span>)
        db.commit()
</code></pre><ul>
<li><p>获取网站信息，并做相关处理。</p>
<p>  第一步利用 urllib2 获取<a href="http://openradar.appspot.com/" target="_blank" rel="external">openradar</a>主页信息。<br>  第二步对获取到的信息，利用 BeautifulSoap 对<code>html</code>进行解析，得到一个buglist。<br>  第三步，由于网页上面的信息是按时间降序的，而我们是希望最新的bug，在本次最后一个发布，这样这条bug会出现在微博主页时间线的最上头。所以我们这里反转buglist。<br>  第四步，遍历buglist，发布没有发布的bug，并把发布过的bug插入数据库存档。</p>
</li>
</ul>
<p>项目在Github上面的地址：<a href="https://github.com/cp0000/radarstream" target="_blank" rel="external">radarstream</a>。</p>
<h4 id="最后">最后</h4>
<p><strong>To track open radar posts, please follow <a href="http://weibo.com/p/1005051666350201" target="_blank" rel="external">@openradarstream</a></strong></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/08/30/openradarstream/" data-id="zxoa8q2luiqsqc3g" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-UICollectionView-Has-Easy-Reording-On-iOS9" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
      <header class="article-header">
        
  
    <a class="article-title" href="/2015/08/22/UICollectionView-Has-Easy-Reording-On-iOS9/">UICollectionViews Now Have Easy Reordering （译）</a>
  

      </header>
    
    <time class="article-date" datetime="2015-08-22T01:52:28.000Z" itemprop="datePublished">08-22-2015</time>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Tech/">Tech</a>
  </div>

  </div>
  <div class="article-inner">
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="iOS_9-0_UICollectionView_拖拽效果实现">iOS 9.0 UICollectionView 拖拽效果实现</h1>
<blockquote>
<p>原文 <a href="http://nshint.io/blog/2015/07/16/uicollectionviews-now-have-easy-reordering/" target="_blank" rel="external">UICollectionViews Now Have Easy Reordering</a></p>
</blockquote>
<p>在<code>UICollectionView</code> 刚出来的时候，我就对其产生了很大的兴趣。相比它的大哥 <code>UITableView</code>，它更加容易进行一些自定义的操作。我们组现在在项目中使用 <code>UICollectionView</code> 要多于 <code>UITableView</code>。伴随着 iOS 9 的 release，<code>UICollectionView</code>排序（动态拖拽）更加简单。在这之前，如果想对 <code>UICollectionView</code> 进行动态拖拽是非常困难的，要想实现动态拖拽，需要去做非常多的工作。话不多说，我们看一下新的 API。文章用到的Sample地址<a href="https://github.com/nshintio/uicollectionview-reordering" target="_blank" rel="external">uicollectionview-reordering</a>。</p>
<p>实现拖动排序最简单的办法是使用 <code>UICollectionViewController</code>, 在 <code>UICollectionViewController</code> 中新增了一个属性  <code>installsStandardGestureForInteractiveMovement</code>, 通过添加手势对cells进行重排。该属性是BOOL型，默认值为 YES。     我们所需要做的，只要重载下面这个方法就好了.</p>
<pre><code><span class="keyword">override</span> <span class="func"><span class="keyword">func</span></span> collectionView(collectionView: <span class="type">UICollectionView</span>,
    moveItemAtIndexPath sourceIndexPath: <span class="type">NSIndexPath</span>,
    toIndexPath destinationIndexPath: <span class="type">NSIndexPath</span>) {
    <span class="comment">// move your data order</span>
}
</code></pre><p>当程序中重载了<code>moveItemAtIndexPath</code>，collectionView 就认为 cell 是可以移动的。</p>
<pre><code>![<span class="link_label">reordering-01</span>](<span class="link_url">http://nshint.io/images/uicollectionview-reordering/1.gif</span>)
</code></pre><p>那如果需要给某一个 <code>UIViewController</code> 中 collection view 实现动态拖动效果，该如何实现呢？事情会变的稍微复杂一点。除了需要实现<code>UICollectionViewDataSource</code>中上面提到的代理方法，还需要重写 <code>installsStandardGestureForInteractiveMovement</code>。不过不用当心，实现起来蛮蛮容易。这里我们需要长按手势<code>UILongPressGestureRecognizer</code>，它能够完全满足拖拽需求。</p>
<pre><code><span class="keyword">override</span> <span class="func"><span class="keyword">func</span></span> viewDidLoad() {
    <span class="keyword">super</span>.viewDidLoad()
    longPressGesture = <span class="type">UILongPressGestureRecognizer</span>(target: <span class="keyword">self</span>, action: <span class="string">"handleLongGesture:"</span>)
    <span class="keyword">self</span>.collectionView.addGestureRecognizer(longPressGesture)
}

<span class="func"><span class="keyword">func</span></span> handleLongGesture(gesture: <span class="type">UILongPressGestureRecognizer</span>) {

    <span class="keyword">switch</span>(gesture.state) {

    <span class="keyword">case</span> <span class="type">UIGestureRecognizerState</span>.<span class="type">Began</span>:
        guard <span class="keyword">let</span> selectedIndexPath = <span class="keyword">self</span>.collectionView.indexPathForItemAtPoint(gesture.locationInView(<span class="keyword">self</span>.collectionView)) <span class="keyword">else</span> {
            <span class="keyword">break</span>
        }
        collectionView.beginInteractiveMovementForItemAtIndexPath(selectedIndexPath)
    <span class="keyword">case</span> <span class="type">UIGestureRecognizerState</span>.<span class="type">Changed</span>:
        collectionView.updateInteractiveMovementTargetPosition(gesture.locationInView(gesture.view!))
    <span class="keyword">case</span> <span class="type">UIGestureRecognizerState</span>.<span class="type">Ended</span>:
        collectionView.endInteractiveMovement()
    <span class="keyword">default</span>:
        collectionView.cancelInteractiveMovement()
    }
}
</code></pre><p>这段代码主要是给 collectionView 添加一个长手势识别器，并根据手势的不同状态调用collectionView的相关方法。</p>
<ul>
<li><code>beginInteractiveMovementForItemAtIndexPath(indexPath: NSIndexPath)</code>: 该方法在开始拖拽某个cell时被调用</li>
<li><code>updateInteractiveMovementTargetPosition(targetPosition:CGPoint)</code>: 根据手势更新拖拽cell的位置</li>
<li><code>endInteractiveMovement()</code>: 手势结束时调用，结束拖拽</li>
<li><code>cancelInteractiveMovement()</code>: 手势取消时调用，取消拖拽</li>
</ul>
<p>这样就实现了需要的拖拽效果：</p>
<p><img src="http://nshint.io/images/uicollectionview-reordering/2.gif" alt="reordering_collection_view"></p>
<p>这段代码出来的效果和 <code>UICollectionViewController</code> 是一致的。很厉害吧，但更厉害的是我们可以用上面的方法对自定义的 collection view layout 进行拖拽。下面我们来实现一个简单的瀑布流。</p>
<p><img src="http://nshint.io/images/uicollectionview-reordering/3.gif" alt="reordering_waterfall"></p>
<p>昂～，看起来还凑合，但在移动的时候cell的size被改变了呢，如何才能保持cell的size不变呢？ <code>UICollectionViewLayout</code>提供了相关办法可以帮助我们解决这个问题。</p>
<pre><code><span class="input"><span class="prompt">func invalidationContextForInteractivelyMovingItems(targetIndexPaths: [NSIndexPath],
    withTargetPosition targetPosition: CGPoint,
    previousIndexPaths: [NSIndexPath],
    previousPosition: CGPoint) -&gt;</span> <span class="constant">UICollectionViewLayoutInvalidationContext</span></span>
<span class="input"><span class="prompt">
func invalidationContextForEndingInteractiveMovementOfItemsToFinalIndexPaths(indexPaths: [NSIndexPath],
    previousIndexPaths: [NSIndexPath],
    movementCancelled: Bool) -&gt;</span> <span class="constant">UICollectionViewLayoutInvalidationContext</span></span>
</code></pre><ul>
<li>第一个函数会在 cells 拖拽过程中被调用</li>
<li><p>第二个函数会在拖拽结束时候被调用。有了这些信息，我们可以使用一点小技巧去实现cell size不被改变的功能。</p>
<p>  internal override func invalidationContextForInteractivelyMovingItems(targetIndexPaths: [NSIndexPath],</p>
<pre><code>  withTargetPosition targetPosition: <span class="built_in">CGPoint</span>,
  previousIndexPaths: [<span class="built_in">NSIndexPath</span>],
  previousPosition: <span class="built_in">CGPoint</span>) -&gt; UICollectionViewLayoutInvalidationContext {

  var context = <span class="keyword">super</span><span class="variable">.invalidationContextForInteractivelyMovingItems</span>(targetIndexPaths,
      withTargetPosition: targetPosition, previousIndexPaths: previousIndexPaths,
      previousPosition: previousPosition)

  <span class="keyword">self</span><span class="variable">.delegate</span>?<span class="variable">.collectionView</span>!(<span class="keyword">self</span><span class="variable">.collectionView</span>!, moveItemAtIndexPath: previousIndexPaths[<span class="number">0</span>],
      toIndexPath: targetIndexPaths[<span class="number">0</span>])

  <span class="keyword">return</span> context
</code></pre><p>  }</p>
</li>
</ul>
<p>解决方法很直接。获取当前被拖拽的cell的起始indexPath和目标indexPath,然后调用UICollectionViewDataSource代理方法移动当前正在被拖拽的cell。</p>
<p>一个可以拖拽的的collectionView带来体验效果真的非常棒～</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/08/22/UICollectionView-Has-Easy-Reording-On-iOS9/" data-id="mgz6y5fjr03uv3kz" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/archives/2015/page/2/">2</a><a class="extend next" rel="next" href="/archives/2015/page/2/">Next &raquo;</a>
    </nav>
  
</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Pei Cheng<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">

  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>



<script src="/js/script.js" type="text/javascript"></script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-63703524-1', 'auto');
  ga('send', 'pageview');

</script>
  </div>
</body>
</html>